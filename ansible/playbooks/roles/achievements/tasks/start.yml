---
- name: Start service
  shell:
    cmd: "./start.sh"
    chdir: "./achievements-bundle/server"
  become: no
  environment:
    PORT: "{{ app_port }}"
    JDBC_DATABASE_URL: "{{ app_jdbc_database_url }}"
    JDBC_DATABASE_USERNAME: "{{ app_db_user_name }}"
    JDBC_DATABASE_PASSWORD: "{{ app_db_user_pw }}"
    GOOGLE_CLIENT_ID: "{{ app_google_client_id }}"
    GOOGLE_CLIENT_SECRET: "{{ app_google_client_secret }}"
    MICROSOFT_CLIENT_ID: "{{ app_microsoft_client_id }}"
    MICROSOFT_CLIENT_SECRET: "{{ app_microsoft_client_secret }}"
    JWT_SIGNING_SECRET: "{{ app_jwt_signing_secret }}"
    SMTP_HOST: "{{ app_smtp_host }}"
    SMTP_PORT: "{{ app_smtp_port }}"
    SMTP_USERNAME: "{{ app_smtp_username }}"
    SMTP_PASSWORD: "{{ app_smtp_password }}"
    SMTP_FROM: "{{ app_smtp_from }}"
    SENTRY_DSN: "{{ app_sentry_dsn }}"
    APP_HOST_NAME: "{{ app_host_name }}"

- name: "Wait for admin API to become available over http:9001"
  become: no
  uri:
    url: "http://localhost:9001/ping"
    timeout: 1
    status_code: [200]
  retries: 10
  delay: 5
  register: admin_api_url_check
  until: admin_api_url_check['status']|default(0) == 200

- name: "Wait for public API to become available over http:8080"
  become: no
  uri:
    url: "http://localhost:8080/api/stats"
    timeout: 1
    status_code: [401]
  retries: 1
  delay: 5
  register: public_api_url_check
  until: public_api_url_check['status']|default(0) == 401 # Yes, 401 is expected but at least it's a proper response

- name: "Check if API is available over http:80 (proxied through Nginx)"
  become: no
  uri:
    url: "http://localhost/api/stats"
    timeout: 5
    status_code: [401]

- name: "Check if HTML is available over http:80 (proxied through Nginx)"
  become: no
  uri:
    url: "http://localhost"
    timeout: 5
    status_code: [200]
